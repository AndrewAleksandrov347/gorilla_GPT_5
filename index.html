<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1 горилла против 100 — пиксельные джунгли</title>
  <style>
    :root{
      --sky:#7dc6b6;         /* небесный оттенок поверх кроны */
      --canopy-2:#0a2219;    /* дальняя зелень */
      --canopy-1:#103728;    /* ближняя зелень */
      --dirt:#3b2a1f;        /* земля */
      --lane:#4c3829;        /* дорожка */
      --lane-b:#2a1d15;      /* бордюр дорожки */
      --hud:#eaf7ef;         /* текст */
      --hud-dim:#b8d0c4;     /* тусклый */
      --accent:#9ee8b6;      /* акцент */
      --bad:#ff8a8a;         /* урон */
    }
    html,body{height:100%;margin:0;background:#0b1a14;color:var(--hud);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;padding:16px}
    .game{position:relative;width:min(960px,96vw);aspect-ratio:16/9;border-radius:12px;background:#0b1a14;box-shadow:0 14px 48px rgba(0,0,0,.6)}
    canvas{width:100%;height:100%;display:block;image-rendering: pixelated;image-rendering: crisp-edges;}

    .hud{position:absolute;left:8px;top:8px;display:flex;gap:8px;z-index:3}
    .hud .box{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:6px 8px;font-weight:800}
    .hud .danger{box-shadow:0 0 0 2px rgba(255,138,138,.25) inset;border-color:rgba(255,138,138,.45)}
    .topright{position:absolute;right:8px;top:8px;display:flex;gap:8px;z-index:3}
    .pill{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);color:#d6f0dd;background:rgba(0,0,0,.3)}

    .screen{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:4}
    .screen.active{display:flex}
    .panel{background:rgba(5,12,9,.9);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:18px 20px;max-width:86%}
    h1{margin:0 0 8px;font-weight:900}
    .subtitle{color:var(--hud-dim);margin-bottom:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.15);background:#0f221a;color:var(--hud);border-radius:8px;padding:8px 12px;font-weight:800}
    button:hover{border-color:rgba(255,255,255,.28)}
    .accent{border-color:rgba(158,232,182,.45);box-shadow:0 0 0 2px rgba(158,232,182,.12) inset}
    .hint{font-size:14px;color:var(--hud-dim);margin-top:8px}

    /* Внутренняя пиксельная рамка у игрового поля — рисуем на канвасе, но на всякий случай и css */
    .game::after{content:"";position:absolute;inset:0;border:3px solid rgba(255,255,255,.08);border-radius:10px;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="game" id="game">
      <canvas id="canvas" width="320" height="180" aria-label="Игровое поле"></canvas>

      <div class="hud" id="hud" hidden>
        <div class="box" id="hudScore">Счёт: 0</div>
        <div class="box" id="hudLives">Жизни: 3</div>
        <div class="box" id="hudWave">Волна: 1/10</div>
        <div class="box" id="hudLeft">Осталось: 100</div>
      </div>
      <div class="topright" id="topright" hidden>
        <div class="pill" id="hudDiff"></div>
        <div class="pill">Стрелки ↑/↓ — дорожки • Пробел — схватить/бросить</div>
      </div>

      <div class="screen active" id="screenStart">
        <div class="panel">
          <h1>1 горилла против 100 человек</h1>
          <div class="subtitle">Пиксельные джунгли. Четыре дорожки. Слева — горилла, справа — толпа.</div>
          <p class="hint">Цепная реакция: брошенный сбивает тех, кого задевает. Столкновение — минус жизнь. Всего 100.</p>
          <p style="margin:10px 0 6px">Сложность:</p>
          <div class="row">
            <button class="btnDiff" data-diff="easy">Лёгко</button>
            <button class="btnDiff accent" data-diff="normal">Норма</button>
            <button class="btnDiff" data-diff="hard">Тяжело</button>
            <button id="btnPractice" title="10 человек, без записи рекорда">Тренировка</button>
          </div>
          <p class="hint">Лучший счёт: <span id="bestScore">—</span></p>
        </div>
      </div>

      <div class="screen" id="screenOver">
        <div class="panel">
          <h1 id="overTitle">Раунд завершён</h1>
          <p class="hint" id="bestLine">Лучший счёт: —</p>
          <div class="row" style="margin-top:10px">
            <button id="btnAgain" class="accent">Снова</button>
            <button id="btnMenu">Меню</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  'use strict';
  // === Параметры пиксельной сетки ===
  const VW=320, VH=180; // виртуальное разрешение (16:9)
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled=false;

  const hud = {
    root: document.getElementById('hud'),
    score: document.getElementById('hudScore'),
    lives: document.getElementById('hudLives'),
    wave: document.getElementById('hudWave'),
    left: document.getElementById('hudLeft'),
    diff: document.getElementById('hudDiff'),
    tr: document.getElementById('topright'),
  };
  const screenStart = document.getElementById('screenStart');
  const screenOver  = document.getElementById('screenOver');
  const bestScoreEl = document.getElementById('bestScore');
  const bestLine = document.getElementById('bestLine');
  const over = {
    title: document.getElementById('overTitle'),
    again: document.getElementById('btnAgain'),
    menu: document.getElementById('btnMenu'),
  };

  document.querySelectorAll('.btnDiff').forEach(btn => btn.addEventListener('click', () => startGame(btn.dataset.diff)));
  document.getElementById('btnPractice').addEventListener('click', () => startGame('practice'));
  over.again.addEventListener('click', () => startGame(lastDiff || 'normal'));
  over.menu.addEventListener('click', backToMenu);

  // Безопасный localStorage
  const BEST_KEY = 'gv100_best';
  function safeGetLS(key){ try{ return window.localStorage ? window.localStorage.getItem(key) : null; }catch(e){ return null; } }
  function safeSetLS(key,val){ try{ if(window.localStorage) window.localStorage.setItem(key,val); }catch(e){} }
  let _bestMem = 0;
  function loadBest(){ const fromLS = safeGetLS(BEST_KEY); const v = +(fromLS ?? _bestMem ?? 0) || 0; _bestMem = Math.max(_bestMem, v); bestScoreEl.textContent = v; return v; }
  function saveBest(score){ const prev = loadBest(); if(score>prev){ _bestMem = score; safeSetLS(BEST_KEY, String(score)); } }
  let lastDiff = 'normal'; loadBest();

  // === Игра: состояние и сложность ===
  const STATE = { MENU:0, PLAY:1, OVER:2 }; let state = STATE.MENU;
  const DIFF = {
    easy:   { name:'Лёгко', lives:3, lanes:4, total:100, waves:10, startThrowersWave:6, spawnBase:900, speedMul:0.85, gorillaSpeed:1.0 },
    normal: { name:'Норма', lives:3, lanes:4, total:100, waves:10, startThrowersWave:3, spawnBase:800, speedMul:1.00, gorillaSpeed:1.0 },
    hard:   { name:'Тяжело',lives:2, lanes:4, total:100, waves:10, startThrowersWave:2, spawnBase:720, speedMul:1.15, gorillaSpeed:1.05 },
    practice:{ name:'Тренировка', lives:3, lanes:4, total:10,  waves:2,  startThrowersWave:99, spawnBase:900, speedMul:0.95, gorillaSpeed:1.0, practice:true }
  };

  // === Геометрия дорожек ===
  const LANES=4; const LANE_H = Math.floor((VH-60)/LANES); const TOP = 20; const LEFT = 18;
  function laneY(i){ return TOP + i*LANE_H + Math.floor(LANE_H/2); }

  // === Объекты ===
  const gorilla = { lane:1, lanes:4, x:LEFT, w:18, h:18, invul:0, speed:80, holding:null, t:0 };
  const enemies=[]; const projectiles=[]; const stones=[];

  let score=0, lives=3, wave=1, totalToSpawn=100, spawned=0, killed=0, escaped=0, processed=0; let waves=10, spawnTimer=0, spawnInterval=900, difficulty=DIFF.normal;

  // === Управление ===
  const keys = new Set(); let keyLatch={up:false,down:false,space:false};
  window.addEventListener('keydown', (e)=>{ if(['ArrowUp','ArrowDown','Space'].includes(e.code)) e.preventDefault(); keys.add(e.code); });
  window.addEventListener('keyup',   (e)=>{ keys.delete(e.code); });

  // === Пиксельные утилиты ===
  const P = (v)=>Math.round(v);
  function pRect(x,y,w,h,color){ ctx.fillStyle=color; ctx.fillRect(P(x),P(y),P(w),P(h)); }
  function pLine(x1,y1,x2,y2,color){ ctx.fillStyle=color; if(y1===y2){ const x=Math.min(x1,x2); const w=Math.abs(x2-x1)+1; pRect(x,y1, w,1,color); } else if(x1===x2){ const y=Math.min(y1,y2); const h=Math.abs(y2-y1)+1; pRect(x1,y, 1,h,color); } }

  // === Фон: пиксельные джунгли и дорожки ===
  function drawBackground(){
    // небо/кроны
    pRect(0,0,VW,VH, getCss('--sky'));
    // силуэты крон
    for(let i=0;i<4;i++){
      const y = 22 + i*6; const h = 8 + (i%2?2:0); const col = i%2? getCss('--canopy-1') : getCss('--canopy-2');
      for(let x= -16; x<VW+16; x+=16){ pRect(x + (i*3)%16, y, 12, h, col); }
    }
    // земля
    pRect(0,VH-28,VW,28, getCss('--dirt'));
    // дорожки (4 полосы)
    for(let i=0;i<LANES;i++){
      const cy = laneY(i); const y = cy - Math.floor(LANE_H/2) + 2; const h = LANE_H - 4;
      pRect(0, y, VW, h, getCss('--lane'));
      pRect(0, y-1, VW, 1, getCss('--lane-b'));
      pRect(0, y+h, VW, 1, getCss('--lane-b'));
    }
    // внутренняя рамка
    pRect(0,0,VW,1,'#000000'); pRect(0,VH-1,VW,1,'#000000'); pRect(0,0,1,VH,'#000000'); pRect(VW-1,0,1,VH,'#000000');
  }

  function getCss(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

  // === Спрайт гориллы (пиксели) ===
  function drawGorilla(){
    const y = laneY(gorilla.lane);
    const gx = gorilla.x; const gy = y - 10;
    // тень
    pRect(gx+2, gy+12, 12,2, 'rgba(0,0,0,.35)');
    // корпус
    pRect(gx,   gy+3, 14,10, '#2f4136');
    // голова
    pRect(gx+3, gy,   8, 4,  '#455b4f');
    // руки (разные позы)
    if(gorilla.holding){ pRect(gx+12, gy+5, 4,3, '#2a3b32'); pRect(gx-3, gy+5, 4,3, '#2a3b32');
      // предмет в руках
      pRect(gx+15, gy+5, 3,3, gorilla.holding.kind==='stone'? '#b2966a' : '#e2b58e');
    } else { pRect(gx+12, gy+6, 3,2, '#2a3b32'); pRect(gx-2, gy+6, 3,2, '#2a3b32'); }
    // «опасность» при неуязвимости
    if(gorilla.invul>0){ pRect(gx-2,gy-2, 18,1, '#ffb3b3'); pRect(gx-2,gy+15, 18,1, '#ffb3b3'); pRect(gx-2,gy-2, 1,18, '#ffb3b3'); pRect(gx+15,gy-2, 1,18, '#ffb3b3'); }
  }

  // === Люди и типы ===
  function enemyColors(type){ switch(type){
    case 'sprinter': return { body:'#f0b072', head:'#ffd4b8', shirt:'#e8b653' };
    case 'zigzag':   return { body:'#efc48a', head:'#ffdcbc', shirt:'#7bd27f' };
    case 'heavy':    return { body:'#e6ab74', head:'#ffd0b0', shirt:'#d57c7c' };
    case 'thrower':  return { body:'#efc48a', head:'#ffdcbc', shirt:'#7db7f0' };
    default:         return { body:'#efc48a', head:'#ffdcbc', shirt:'#cfc57a' };
  } }
  function drawEnemy(e){
    const cy=laneY(e.lane); const x=P(e.x), y=cy-9; const c=enemyColors(e.type);
    // тень
    pRect(x-1, y+12, 10,2, 'rgba(0,0,0,.25)');
    // ноги
    pRect(x,   y+10, 3,3, c.body); pRect(x+5, y+10, 3,3, c.body);
    // туловище
    pRect(x-1, y+3, 10,8, c.shirt);
    // голова
    pRect(x+1, y,   5,3,  c.head);
    if(e.type==='thrower' && e.state==='tele'){ // пиктограмма «!»
      pRect(x+2, y-5, 2,3, '#ffe08a'); pRect(x+2, y-1, 2,1, '#ffe08a');
    }
  }

  // === Снаряды ===
  function drawProjectile(p){ const cy=laneY(p.lane); const x=P(p.x); const y=cy-6; if(p.kind==='stone'){ pRect(x, y, 3,3, '#b2966a'); } else { pRect(x, y, 4,4, '#e2b58e'); pRect(x-1,y+1,1,2,'#e2b58e'); } }
  function drawStone(s){ const cy=laneY(s.lane); pRect(P(s.x), cy-6, 3,3, '#b2966a'); }

  // === Логика (берём из предыдущей версии, адаптируем координаты) ===
  function rectsOverlap(ax,aw,bx,bw){ return Math.abs(ax-bx) < (aw/2 + bw/2); }

  function spawnEnemy(){ if(spawned >= totalToSpawn) return; const lane = Math.floor(Math.random()*gorilla.lanes); const wv=wave; const allowThrower = (wv >= difficulty.startThrowersWave); const pool=[]; pool.push(['runner',50]); pool.push(['sprinter',10 + Math.max(0,wv-3)*4]); pool.push(['zigzag',8 + Math.max(0,wv-2)*3]); pool.push(['heavy',8 + Math.max(0,wv-4)*3]); if(allowThrower) pool.push(['thrower', 6 + Math.max(0,wv-5)*3]); const sum = pool.reduce((s,[,v])=>s+v,0); let r=Math.random()*sum, type='runner'; for(const [t,v] of pool){ r-=v; if(r<=0){ type=t; break; } } const baseSpeed=24 * difficulty.speedMul; let speed=baseSpeed; if(type==='sprinter') speed*=1.9; else if(type==='heavy') speed*=0.64; else if(type==='thrower') speed*=0.95; else if(type==='zigzag') speed*=1.07; const e={ type, lane, x: VW + 10, w:8, h:12, speed, zigTimer: 0.5 + Math.random()*0.7, state:'run', teleTimer:0.7, stopX: Math.max(120, 160 - wv*3 + Math.random()*18), }; enemies.push(e); spawned++; }

  let lastTs=0; function loop(ts){ requestAnimationFrame(loop); if(state!==STATE.PLAY) return; const dt=Math.min(0.033, (ts - lastTs)/1000 || 0); lastTs=ts; gorilla.t += dt;
    // управление по дорожкам
    if(keys.has('ArrowUp') && !keyLatch.up){ gorilla.lane=Math.max(0, gorilla.lane-1); keyLatch.up=true; }
    if(!keys.has('ArrowUp')) keyLatch.up=false;
    if(keys.has('ArrowDown') && !keyLatch.down){ gorilla.lane=Math.min(gorilla.lanes-1, gorilla.lane+1); keyLatch.down=true; }
    if(!keys.has('ArrowDown')) keyLatch.down=false;
    // действия
    if(keys.has('Space') && !keyLatch.space){ keyLatch.space=true; if(gorilla.holding){ const p={ kind:gorilla.holding.kind, lane: gorilla.lane, x: gorilla.x+20, vx: 110, r: 3, mass: gorilla.holding.mass||'normal' }; projectiles.push(p); gorilla.holding=null; } else {
        let target=null, minDx=9999; for(const e of enemies){ if(e.lane!==gorilla.lane) continue; const dx=e.x-(gorilla.x+16); if(dx>=-4 && dx<minDx && dx<22){ target=e; minDx=dx; } } if(target){ const idx=enemies.indexOf(target); if(idx>=0) enemies.splice(idx,1); gorilla.holding={ kind:'body', lane:gorilla.lane, mass: target.type==='heavy'?'heavy':'normal' }; processed++; } else { for(let i=0;i<stones.length;i++){ const s=stones[i]; if(s.lane!==gorilla.lane) continue; const dx=Math.abs(s.x-(gorilla.x+18)); if(dx<16){ gorilla.holding={kind:'stone',lane:gorilla.lane}; stones.splice(i,1); break; } } }
    } }
    if(!keys.has('Space')) keyLatch.space=false;

    // спавн
    spawnTimer -= dt*1000; if(spawnTimer<=0){ spawnEnemy(); const waveP = (spawned)/(totalToSpawn); const waveIdx = Math.floor(waveP * waves) + 1; spawnInterval = difficulty.spawnBase - (waveIdx-1)*40; spawnTimer = Math.max(260, spawnInterval + (Math.random()*120-60)); }

    // движение врагов
    for(let i=enemies.length-1;i>=0;i--){ const e=enemies[i]; if(e.type==='zigzag'){ e.zigTimer -= dt; if(e.zigTimer<=0){ e.zigTimer=0.45+Math.random()*0.7; const dir=Math.random()<.5?-1:1; e.lane=Math.min(gorilla.lanes-1, Math.max(0, e.lane+dir)); } }
      if(e.type==='thrower'){
        if(e.state==='run'){ e.x -= e.speed*dt; if(e.x<=e.stopX){ e.state='tele'; e.teleTimer = 0.7; } }
        else if(e.state==='tele'){ e.teleTimer -= dt; if(e.teleTimer<=0){ e.state='throw'; } }
        else if(e.state==='throw'){ stones.push({ lane:e.lane, x:e.x-6, vx: -110 * difficulty.speedMul }); e.state='resume'; }
        else if(e.state==='resume'){ e.x -= e.speed*dt*0.95; }
      } else { e.x -= e.speed*dt; }
      // столкновение с гориллой
      if(e.lane===gorilla.lane && !gorilla.holding){ if(rectsOverlap(e.x, 8, gorilla.x+12, 16)){ if(gorilla.invul<=0){ lives--; gorilla.invul=0.9; flashLives(); } enemies.splice(i,1); processed++; } }
      if(e && e.x < -12){ enemies.splice(i,1); escaped++; processed++; }
    }

    // камни
    for(let i=stones.length-1;i>=0;i--){ const s=stones[i]; s.x += s.vx*dt; if(s.lane===gorilla.lane && Math.abs(s.x-(gorilla.x+14))<10){ if(keys.has('Space') && !gorilla.holding){ gorilla.holding={kind:'stone',lane:gorilla.lane}; stones.splice(i,1); continue; } if(gorilla.invul<=0){ lives--; gorilla.invul=0.9; flashLives(); } stones.splice(i,1); } if(s.x < -12) stones.splice(i,1); }

    // снаряды
    for(let i=projectiles.length-1;i>=0;i--){ const p=projectiles[i]; p.x += p.vx*dt; for(let j=enemies.length-1;j>=0;j--){ const e=enemies[j]; if(e.lane!==p.lane) continue; if(Math.abs(p.x - e.x) < 6){ enemies.splice(j,1); killed++; processed++; score++; } } if(p.x > VW+12) projectiles.splice(i,1); }

    // волны/конец
    const newWave = Math.floor(processed / Math.max(1, Math.ceil(totalToSpawn / waves))) + 1; wave = Math.min(waves, newWave);
    if(lives<=0 || processed>=totalToSpawn){ endRound(lives>0); return; }

    // отрисовка
    ctx.clearRect(0,0,VW,VH); drawBackground();
    for(const e of enemies) drawEnemy(e); for(const s of stones) drawStone(s); for(const p of projectiles) drawProjectile(p); drawGorilla();
    hud.score.textContent = `Счёт: ${score}`; hud.lives.textContent = `Жизни: ${Math.max(0,lives)}`; hud.wave.textContent = `Волна: ${wave}/${waves}`; hud.left.textContent = `Осталось: ${Math.max(0,totalToSpawn-processed)}`;
    if(gorilla.invul>0) gorilla.invul = Math.max(0, gorilla.invul - dt);
  }

  function flashLives(){ hud.lives.classList.add('danger'); setTimeout(()=>hud.lives.classList.remove('danger'), 200); }

  // === Старт/финиш ===
  function startGame(diffKey){ lastDiff=diffKey; difficulty=DIFF[diffKey]||DIFF.normal; state=STATE.PLAY; screenStart.classList.remove('active'); screenOver.classList.remove('active'); hud.root.hidden=false; hud.tr.hidden=false; hud.diff.textContent=difficulty.name; gorilla.lanes=difficulty.lanes; gorilla.lane=Math.floor(gorilla.lanes/2); gorilla.holding=null; gorilla.invul=0; enemies.length=0; projectiles.length=0; stones.length=0; score=0; lives=difficulty.lives; wave=1; totalToSpawn=difficulty.total; waves=difficulty.waves; spawned=0; killed=0; escaped=0; processed=0; spawnTimer=300; spawnInterval=difficulty.spawnBase; lastTs=performance.now(); requestAnimationFrame(loop); }
  function endRound(won){ state=STATE.OVER; hud.root.hidden=true; hud.tr.hidden=true; over.title.textContent=(won?'Победа!':'Горилла пала…'); if(!difficulty.practice){ saveBest(score);} bestLine.textContent='Лучший счёт: '+loadBest(); screenOver.classList.add('active'); }
  function backToMenu(){ state=STATE.MENU; hud.root.hidden=true; hud.tr.hidden=true; screenOver.classList.remove('active'); screenStart.classList.add('active'); loadBest(); }

  // первичная картинка
  drawBackground();
  drawGorilla();
})();
</script>
</body>
</html>
